<!DOCTYPE html>
<html lang="en">
<head>
    <title>{{ title|text }} - OpenEMR</title>
    {{ setupHeader() }}
    <style>
        .status-pass { color: #28a745; }
        .status-fail { color: #dc3545; }
        .card { margin-bottom: 1rem; }
        .checklist-item { padding: 0.5rem 0; border-bottom: 1px solid #eee; }
        .checklist-item:last-child { border-bottom: none; }
        .email-preview { background: #f8f9fa; padding: 1rem; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
        .onc-logo { max-width: 120px; height: auto; }
        .onc-header { display: flex; align-items: center; gap: 1.5rem; }
        .card-header { cursor: pointer; }
        .card-header:hover { background-color: #f8f9fa; }
        .card-header .collapse-icon { transition: transform 0.2s; }
        .card-header.collapsed .collapse-icon { transform: rotate(-90deg); }
        .registration-verified { background-color: #d4edda; border-color: #c3e6cb; }
        .registration-pending { background-color: #fff3cd; border-color: #ffeeba; }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="onc-header">
                    <img src="https://opencoreemr.com/assets/onc-logo-iNVYUQvE.png"
                         alt="{{ 'ONC Health IT Certification'|xlt }}"
                         class="onc-logo">
                    <div>
                        <h1><i class="fa fa-certificate"></i> {{ 'ONC Registration'|xlt }}</h1>
                        <p class="lead mb-0">{{ 'Manage your ONC certification registration for this OpenEMR installation.'|xlt }}</p>
                    </div>
                </div>
                <hr>
            </div>
        </div>

        {# Determine if registration is complete (verified on published page) #}
        {% set is_registered = registration_verification.registered %}
        {% set is_ready_to_submit = all_settings_valid and registration_info.complete %}

        {# 1. Registration Status Card - Always expanded #}
        <div class="row">
            <div class="col-12">
                <div class="card {{ is_registered ? 'registration-verified' : (is_ready_to_submit ? 'registration-pending' : '') }}">
                    <div class="card-header" data-toggle="collapse" data-target="#registrationStatus" data-bs-toggle="collapse" data-bs-target="#registrationStatus">
                        <i class="fa fa-clipboard-check"></i> {{ 'Registration Status'|xlt }}
                        <i class="fa fa-chevron-down collapse-icon float-right float-end"></i>
                        {% if is_registered %}
                            <span class="badge bg-success float-right float-end mr-2 me-2">{{ 'Registered'|xlt }}</span>
                        {% elseif is_ready_to_submit %}
                            <span class="badge bg-warning text-dark float-right float-end mr-2 me-2">{{ 'Ready to Submit'|xlt }}</span>
                        {% else %}
                            <span class="badge bg-secondary float-right float-end mr-2 me-2">{{ 'Not Ready'|xlt }}</span>
                        {% endif %}
                    </div>
                    <div id="registrationStatus" class="collapse show">
                        <div class="card-body">
                            {% if is_registered %}
                                <div class="text-center py-4">
                                    <i class="fa fa-check-circle fa-4x status-pass mb-3"></i>
                                    <h3 class="text-success">{{ 'Registration Verified'|xlt }}</h3>
                                    <p class="lead">{{ 'Your FHIR endpoint is listed on the OpenEMR Foundation\'s published Service Base URLs page.'|xlt }}</p>
                                    <p>
                                        <strong>{{ 'FHIR Endpoint'|xlt }}:</strong> <code>{{ fhir_endpoint|text }}</code>
                                    </p>
                                    <a href="{{ published_urls_page|attr }}" target="_blank" class="btn btn-outline-success">
                                        <i class="fa fa-external-link-alt"></i> {{ 'View Published URLs'|xlt }}
                                    </a>
                                </div>
                            {% elseif is_ready_to_submit %}
                                <div class="text-center py-3">
                                    <i class="fa fa-hourglass-half fa-3x text-warning mb-3"></i>
                                    <h4>{{ 'Ready to Submit Registration'|xlt }}</h4>
                                    <p>{{ 'All requirements are met. Submit your registration to the OpenEMR Foundation.'|xlt }}</p>
                                    <p class="text-muted small">{{ 'After submitting, your endpoint should appear on the published page within 10 business days.'|xlt }}</p>
                                </div>
                            {% else %}
                                <div class="text-center py-3">
                                    <i class="fa fa-exclamation-triangle fa-3x text-secondary mb-3"></i>
                                    <h4>{{ 'Registration Not Ready'|xlt }}</h4>
                                    <p>{{ 'Complete the configuration requirements below before submitting registration.'|xlt }}</p>
                                </div>
                            {% endif %}

                            {% if registration_verification.error %}
                                <div class="alert alert-info mt-3 mb-0">
                                    <i class="fa fa-info-circle"></i>
                                    {{ 'Note'|xlt }}: {{ registration_verification.error|text }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# 2. About ONC Certification Card #}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header {{ is_registered ? 'collapsed' : '' }}" data-toggle="collapse" data-target="#aboutCertification" data-bs-toggle="collapse" data-bs-target="#aboutCertification">
                        <i class="fa fa-info-circle"></i> {{ 'About ONC Certification'|xlt }}
                        <i class="fa fa-chevron-down collapse-icon float-right float-end"></i>
                    </div>
                    <div id="aboutCertification" class="collapse {{ is_registered ? '' : 'show' }}">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-9">
                                    <p>{{ 'OpenEMR is ONC Certified. For your installation to use this certification, you must:'|xlt }}</p>
                                    <ol>
                                        <li>{{ 'Configure the required global settings (see checklist below)'|xlt }}</li>
                                        <li>{{ 'Ensure your FHIR endpoint is publicly accessible via HTTPS'|xlt }}</li>
                                        <li>{{ 'Register your organization details with the OpenEMR Foundation'|xlt }}</li>
                                        <li>{{ 'Use end-user devices with AES-encrypted drives'|xlt }}</li>
                                        <li>{{ 'Use FIPS-compliant SSL/TLS ciphers'|xlt }}</li>
                                        <li>{{ 'Support NTP v4 (RFC 5905) for time synchronization'|xlt }}</li>
                                    </ol>
                                    <p>
                                        <a href="https://www.open-emr.org/wiki/index.php/OpenEMR_7.0.2_ONC_Certification_Requirements" target="_blank">
                                            {{ 'Read the full ONC Certification Requirements'|xlt }} <i class="fa fa-external-link-alt"></i>
                                        </a>
                                    </p>
                                </div>
                                <div class="col-md-3 text-center">
                                    <img src="https://opencoreemr.com/assets/onc-logo-iNVYUQvE.png"
                                         alt="{{ 'ONC Health IT Certification'|xlt }}"
                                         class="img-fluid" style="max-width: 150px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# 3. Configuration Checklist Card #}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header {{ is_registered ? 'collapsed' : '' }}" data-toggle="collapse" data-target="#configChecklist" data-bs-toggle="collapse" data-bs-target="#configChecklist">
                        <i class="fa fa-check-circle"></i> {{ 'Configuration Checklist'|xlt }}
                        <i class="fa fa-chevron-down collapse-icon float-right float-end"></i>
                        {% if all_settings_valid %}
                            <span class="badge bg-success float-right float-end mr-2 me-2">{{ 'All Passed'|xlt }}</span>
                        {% else %}
                            <span class="badge bg-danger float-right float-end mr-2 me-2">{{ validation_summary.failed }} {{ 'Failed'|xlt }}</span>
                        {% endif %}
                    </div>
                    <div id="configChecklist" class="collapse {{ is_registered ? '' : 'show' }}">
                        <div class="card-body">
                            <p class="text-muted">{{ 'Required OpenEMR settings for ONC certification:'|xlt }}</p>

                            {% for key, item in config_validation %}
                                <div class="checklist-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ item.description|text }}</strong>
                                        <br>
                                        <small class="text-muted">
                                            {{ 'Required'|xlt }}: <code>{{ item.required|text }}</code>
                                            {% if not item.passed %}
                                                | {{ 'Current'|xlt }}: <code>{{ item.actual|text ?: '(empty)' }}</code>
                                            {% endif %}
                                        </small>
                                    </div>
                                    <div>
                                        {% if item.passed %}
                                            <i class="fa fa-check-circle fa-lg status-pass"></i>
                                        {% else %}
                                            <i class="fa fa-times-circle fa-lg status-fail"></i>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}

                            {% if not all_settings_valid %}
                                <div class="alert alert-warning mt-3 mb-0">
                                    <i class="fa fa-exclamation-triangle"></i>
                                    {{ 'Some settings need to be configured. Go to Administration > Globals to update them.'|xlt }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# 4. Organization Information Card #}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header {{ is_registered ? 'collapsed' : '' }}" data-toggle="collapse" data-target="#orgInfo" data-bs-toggle="collapse" data-bs-target="#orgInfo">
                        <i class="fa fa-building"></i> {{ 'Organization Information'|xlt }}
                        <i class="fa fa-chevron-down collapse-icon float-right float-end"></i>
                        {% if registration_info.complete %}
                            <span class="badge bg-success float-right float-end mr-2 me-2">{{ 'Complete'|xlt }}</span>
                        {% else %}
                            <span class="badge bg-warning float-right float-end mr-2 me-2">{{ 'Incomplete'|xlt }}</span>
                        {% endif %}
                    </div>
                    <div id="orgInfo" class="collapse {{ is_registered ? '' : 'show' }}">
                        <div class="card-body">
                            <p class="text-muted">{{ 'Information required for ONC registration:'|xlt }}</p>

                            <table class="table table-sm">
                                <tr>
                                    <th>{{ 'Organization Name'|xlt }}</th>
                                    <td>
                                        {% if org_name %}
                                            {{ org_name|text }}
                                        {% else %}
                                            <span class="text-danger">{{ 'Not configured'|xlt }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>{{ 'Organization Location'|xlt }}</th>
                                    <td>
                                        {% if org_location %}
                                            {{ org_location|text }}
                                        {% else %}
                                            <span class="text-danger">{{ 'Not configured'|xlt }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>{{ 'Organization NPI'|xlt }}</th>
                                    <td>
                                        {% if org_npi %}
                                            {{ org_npi|text }}
                                            {% if npi_validation %}
                                                {% if npi_validation.valid %}
                                                    <i class="fa fa-check-circle status-pass" title="{{ 'Valid NPI'|xlt }}"></i>
                                                {% else %}
                                                    <i class="fa fa-exclamation-circle status-fail" title="{{ npi_validation.error|text }}"></i>
                                                    <small class="text-danger">{{ npi_validation.error|text }}</small>
                                                {% endif %}
                                            {% endif %}
                                        {% else %}
                                            <span class="text-danger">{{ 'Not configured'|xlt }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>{{ 'FHIR Endpoint'|xlt }}</th>
                                    <td>
                                        {% if fhir_endpoint %}
                                            <code>{{ fhir_endpoint|text }}</code>
                                            <small class="text-muted">({{ 'auto-detected'|xlt }})</small>
                                        {% else %}
                                            <span class="text-danger">{{ 'Not configured'|xlt }}</span>
                                            <br><small class="text-muted">{{ 'Set Site Address in Administration > Globals > Connectors'|xlt }}</small>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>

                            {% if not registration_info.complete %}
                                <div class="alert alert-warning mb-0">
                                    <i class="fa fa-exclamation-triangle"></i>
                                    {{ 'Missing:'|xlt }} {{ registration_info.missing|join(', ') }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# 5. Submit Registration Card #}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header {{ is_registered ? 'collapsed' : '' }}" data-toggle="collapse" data-target="#submitRegistration" data-bs-toggle="collapse" data-bs-target="#submitRegistration">
                        <i class="fa fa-paper-plane"></i> {{ 'Submit Registration'|xlt }}
                        <i class="fa fa-chevron-down collapse-icon float-right float-end"></i>
                    </div>
                    <div id="submitRegistration" class="collapse {{ is_registered ? '' : 'show' }}">
                        <div class="card-body">
                            {% if is_registered %}
                                <div class="alert alert-success">
                                    <i class="fa fa-check-circle"></i>
                                    {{ 'Your installation is already registered. No further action needed.'|xlt }}
                                </div>
                            {% elseif not is_ready_to_submit %}
                                <div class="alert alert-danger">
                                    <i class="fa fa-exclamation-circle"></i>
                                    {{ 'Cannot submit registration until all configuration requirements are met.'|xlt }}
                                </div>
                            {% else %}
                                <p>{{ 'To register your installation with the OpenEMR Foundation, send an email to'|xlt }}
                                   <strong>{{ registration_email|text }}</strong> {{ 'with subject'|xlt }}
                                   <strong>"{{ registration_subject|text }}"</strong>.</p>

                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>{{ 'Option 1: Send via Email Client'|xlt }}</h5>
                                        <a href="{{ mailto_link|attr }}" class="btn btn-primary btn-lg">
                                            <i class="fa fa-envelope"></i> {{ 'Open Email Client'|xlt }}
                                        </a>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>{{ 'Option 2: Copy and Send Manually'|xlt }}</h5>
                                        <p><strong>{{ 'To'|xlt }}:</strong> {{ registration_email|text }}</p>
                                        <p><strong>{{ 'Subject'|xlt }}:</strong> {{ registration_subject|text }}</p>
                                        <p><strong>{{ 'Body'|xlt }}:</strong></p>
                                        <div class="email-preview">{{ email_body|text }}</div>
                                        <button type="button" class="btn btn-secondary mt-2" onclick="copyEmailBody()">
                                            <i class="fa fa-copy"></i> {{ 'Copy to Clipboard'|xlt }}
                                        </button>
                                    </div>
                                </div>
                            {% endif %}

                            <hr>

                            <h5>{{ 'Verify Registration'|xlt }}</h5>
                            <p>{{ 'After submitting, your FHIR endpoint should appear on the published Service Base URLs page within 10 business days.'|xlt }}</p>
                            <a href="{{ published_urls_page|attr }}" target="_blank" class="btn btn-outline-secondary">
                                <i class="fa fa-external-link-alt"></i> {{ 'View Published URLs'|xlt }}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function copyEmailBody() {
            const emailBody = {{ email_body|json_encode|raw }};
            navigator.clipboard.writeText(emailBody).then(function() {
                alert('{{ 'Email body copied to clipboard!'|xlj }}');
            }, function() {
                alert('{{ 'Failed to copy. Please select and copy manually.'|xlj }}');
            });
        }
    </script>
</body>
</html>
